<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Management Diary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .storage-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #bdc3c7;
        }

        .btn-excel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .cases-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .case-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-left: 5px solid;
            transition: all 0.3s ease;
            position: relative;
        }

        .case-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .case-card.urgent {
            border-left-color: #e74c3c;
        }

        .case-card.normal {
            border-left-color: #f39c12;
        }

        .case-card.completed {
            border-left-color: #27ae60;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .case-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .case-client {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 15px;
        }

        .case-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .detail-label {
            font-weight: 500;
            color: #34495e;
        }

        .detail-value {
            color: #7f8c8d;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-urgent {
            background: #ffebee;
            color: #c62828;
        }

        .status-normal {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .case-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            font-size: 1em;
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            background: white;
            font-size: 1em;
        }

        .no-cases {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .no-cases-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .backup-reminder {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .reminder-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .reminder-section h3 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reminder-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .reminder-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .reminder-option input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .reminder-option label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .custom-reminder {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .reminder-badge {
            background: #fff3cd;
            color: #856404;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .reminder-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .reminder-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .reminder-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 500;
        }

        .reminder-tab:hover {
            color: #495057;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .client-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .client-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .client-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
        }

        .client-stats {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .client-stat {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .client-case-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .text-red-800 {
            color: #991b1b;
        }

        .font-bold {
            font-weight: bold;
        }

        .priority-high {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        }

        .priority-medium {
            background: linear-gradient(135deg, #ffa726, #ffcc02);
        }

        .priority-low {
            background: linear-gradient(135deg, #26a69a, #4db6ac);
        }

        .priority-completed {
            background: linear-gradient(135deg, #66bb6a, #81c784);
        }

        .priority-reminder {
            background: linear-gradient(135deg, #ff9a56, #ffad56);
        }

        .priority-clients {
            background: linear-gradient(135deg, #42a5f5, #64b5f6);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }

            .cases-container {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: auto;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
            }

            .detail-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .custom-reminder {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Case Management Diary</h1>
            <p>Track your clients, deadlines, and work progress</p>
            <div class="storage-status" id="storageStatus">
                üíæ Data stored locally on your device
            </div>
        </div>

        <div class="main-content">
            <div class="backup-reminder">
                üí° <strong>Tip:</strong> Your data is stored locally on this device. Use "Export Data" to create backups!
            </div>

            <div class="stats-grid">
                <div class="stat-card priority-high">
                    <div class="stat-number" id="totalCases">0</div>
                    <div class="stat-label">Total Cases</div>
                </div>
                <div class="stat-card priority-medium">
                    <div class="stat-number" id="activeCases">0</div>
                    <div class="stat-label">Active Cases</div>
                </div>
                <div class="stat-card priority-low">
                    <div class="stat-number" id="urgentCases">0</div>
                    <div class="stat-label">Urgent Cases</div>
                </div>
                <div class="stat-card priority-completed">
                    <div class="stat-number" id="completedCases">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card priority-clients">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Total Clients</div>
                </div>
            </div>

            <div class="reminder-tabs">
                <button class="reminder-tab active" onclick="switchTab('cases', this)">üìã Cases</button>
                <button class="reminder-tab" onclick="switchTab('clients', this)">üë• Clients</button>
            </div>

            <div id="casesTab" class="tab-content active">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openAddCaseModal()">
                        ‚ûï Add New Case
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        üì§ Export JSON
                    </button>
                    <button class="btn btn-excel" onclick="exportToExcel()">
                        üìä Export Excel
                    </button>
                    <button class="btn btn-secondary" onclick="importData()">
                        üì• Import Data
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="background: #e74c3c; color: white;">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="üîç Search cases by client name or case title...">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="urgent">Urgent</option>
                        <option value="normal">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select class="filter-select" id="sortBy">
                        <option value="deadline">Sort by Deadline</option>
                        <option value="client">Sort by Client</option>
                        <option value="progress">Sort by Progress</option>
                        <option value="created">Sort by Created Date</option>
                    </select>
                </div>

                <div class="cases-container" id="casesContainer">
                    <div class="no-cases">
                        <div class="no-cases-icon">üìã</div>
                        <h3>No cases yet</h3>
                        <p>Click "Add New Case" to get started</p>
                    </div>
                </div>
            </div>

            <div id="clientsTab" class="tab-content">
                <div class="action-buttons">
                    <button class="btn btn-excel" onclick="exportClientsToExcel()">
                        üìä Export Clients to Excel
                    </button>
                </div>
                
                <div class="search-filter">
                    <input type="text" class="search-input" id="clientSearchInput" placeholder="üîç Search clients...">
                    <select class="filter-select" id="clientSortBy">
                        <option value="name">Sort by Name</option>
                        <option value="cases">Sort by Case Count</option>
                        <option value="recent">Sort by Recent Activity</option>
                    </select>
                </div>

                <div id="clientsContainer">
                    <div class="no-cases">
                        <div class="no-cases-icon">üë•</div>
                        <h3>No clients yet</h3>
                        <p>Add cases to see your clients here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Case Modal -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCaseModal()">&times;</span>
            <h2 id="modalTitle">Add New Case</h2>
            <form id="caseForm">
                <div class="form-group">
                    <label for="caseTitle">Case Title*</label>
                    <input type="text" id="caseTitle" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientName">Client Name*</label>
                        <input type="text" id="clientName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientContact">Client Contact</label>
                        <input type="text" id="clientContact" placeholder="Phone/Email">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="caseType">Case Type</label>
                        <select id="caseType">
                            <option value="Civil">Civil</option>
                            <option value="Tax">Tax</option>
                            <option value="Electricity Matter">Electricity Matter</option>
                            <option value="Criminal Matter">Criminal Matter</option>
                            <option value="Corporate">Corporate</option>
                            <option value="Family">Family</option>
                            <option value="Property">Property</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="deadline">Deadline</label>
                        <input type="date" id="deadline">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Priority</label>
                        <select id="priority">
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="progress">Progress (%)</label>
                        <input type="range" id="progress" min="0" max="100" value="0" oninput="updateProgressDisplay()">
                        <span id="progressDisplay">0%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="workDone">Work Done</label>
                    <textarea id="workDone" placeholder="Describe the work completed so far..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="nextSteps">Next Steps</label>
                    <textarea id="nextSteps" placeholder="What needs to be done next..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" placeholder="Any additional information..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">üíæ Save Case</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCaseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <!-- Include SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let cases = [];
        let editingCaseId = null;
        const STORAGE_KEY = 'caseDiaryData';

        // Local Storage Management
        function saveCases() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cases));
                updateStorageStatus();
                return true;
            } catch (error) {
                console.error('Storage error:', error);
                alert('Error saving data: ' + error.message);
                return false;
            }
        }

        function loadCases() {
            try {
                const savedCases = localStorage.getItem(STORAGE_KEY);
                if (savedCases) {
                    cases = JSON.parse(savedCases);
                } else {
                    // Sample data
                    cases = [
                        {
                            id: 1,
                            title: "Contract Dispute - ABC Corp",
                            client: "ABC Corporation",
                            contact: "john@abc.com",
                            type: "Corporate",
                            deadline: "2025-09-15",
                            priority: "urgent",
                            progress: 65,
                            workDone: "Reviewed contract terms, drafted initial response",
                            nextSteps: "Schedule mediation session",
                            notes: "High-value client",
                            createdDate: "2025-08-15",
                            status: "urgent"
                        },
                        {
                            id: 2,
                            title: "Property Settlement",
                            client: "Sarah Johnson",
                            contact: "+91-9876543210",
                            type: "Property",
                            deadline: "2025-10-01",
                            priority: "normal",
                            progress: 30,
                            workDone: "Initial documentation review",
                            nextSteps: "Property valuation",
                            notes: "Straightforward case",
                            createdDate: "2025-08-20",
                            status: "normal"
                        }
                    ];
                    saveCases();
                }
            } catch (error) {
                console.error('Error loading cases:', error);
                cases = [];
            }
        }

        function updateStorageStatus() {
            const now = new Date().toLocaleString();
            const statusEl = document.getElementById('storageStatus');
            if (statusEl) {
                statusEl.innerHTML = `üíæ Data stored locally ‚Ä¢ Last saved: ${now}`;
            }
        }

        // Excel Export Functions
        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Excel export library not loaded. Please refresh the page and try again.');
                return;
            }

            try {
                const workbook = XLSX.utils.book_new();
                
                // Cases data
                const casesData = cases.map(c => ({
                    'Case ID': c.id,
                    'Title': c.title,
                    'Client Name': c.client,
                    'Contact': c.contact || '',
                    'Case Type': c.type,
                    'Priority': c.priority,
                    'Status': c.status,
                    'Progress (%)': c.progress,
                    'Deadline': c.deadline || '',
                    'Created Date': c.createdDate,
                    'Work Done': c.workDone || '',
                    'Next Steps': c.nextSteps || '',
                    'Notes': c.notes || ''
                }));
                
                const casesWorksheet = XLSX.utils.json_to_sheet(casesData);
                XLSX.utils.book_append_sheet(workbook, casesWorksheet, "Cases");
                
                // Clients summary data
                const clientsData = getClientsData().map(client => ({
                    'Client Name': client.name,
                    'Contact': client.contact,
                    'Total Cases': client.totalCases,
                    'Active Cases': client.activeCases,
                    'Completed Cases': client.completedCases,
                    'Urgent Cases': client.urgentCases,
                    'Average Progress': client.averageProgress + '%',
                    'Last Activity': client.lastActivity
                }));
                
                const clientsWorksheet = XLSX.utils.json_to_sheet(clientsData);
                XLSX.utils.book_append_sheet(workbook, clientsWorksheet, "Clients Summary");
                
                // Statistics data
                const statsData = [{
                    'Total Cases': cases.length,
                    'Active Cases': cases.filter(c => c.status !== 'completed').length,
                    'Urgent Cases': cases.filter(c => c.status === 'urgent').length,
                    'Completed Cases': cases.filter(c => c.status === 'completed').length,
                    'Total Clients': new Set(cases.map(c => c.client)).size,
                    'Export Date': new Date().toISOString()
                }];
                
                const statsWorksheet = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(workbook, statsWorksheet, "Statistics");
                
                const filename = `case-diary-export-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, filename);
                
                alert(`Excel file exported successfully as: ${filename}`);
            } catch (error) {
                console.error('Excel export error:', error);
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        function exportClientsToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Excel export library not loaded. Please refresh the page and try again.');
                return;
            }

            try {
                const workbook = XLSX.utils.book_new();
                
                const clientsData = getClientsData().map(client => ({
                    'Client Name': client.name,
                    'Contact Information': client.contact,
                    'Total Cases': client.totalCases,
                    'Active Cases': client.activeCases,
                    'Completed Cases': client.completedCases,
                    'Urgent Cases': client.urgentCases,
                    'Average Progress': client.averageProgress + '%',
                    'Last Activity': client.lastActivity,
                    'Case Types': client.caseTypes.join(', ')
                }));
                
                const clientsWorksheet = XLSX.utils.json_to_sheet(clientsData);
                XLSX.utils.book_append_sheet(workbook, clientsWorksheet, "Clients");
                
                const filename = `clients-export-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, filename);
                
                alert(`Clients Excel file exported successfully as: ${filename}`);
            } catch (error) {
                console.error('Clients Excel export error:', error);
                alert('Error exporting clients to Excel: ' + error.message);
            }
        }

        // Client Management Functions
        function getClientsData() {
            const clientsMap = new Map();
            
            cases.forEach(c => {
                if (!clientsMap.has(c.client)) {
                    clientsMap.set(c.client, {
                        name: c.client,
                        contact: c.contact || 'Not provided',
                        cases: [],
                        totalCases: 0,
                        activeCases: 0,
                        completedCases: 0,
                        urgentCases: 0,
                        lastActivity: c.createdDate,
                        caseTypes: new Set()
                    });
                }
                
                const client = clientsMap.get(c.client);
                client.cases.push(c);
                client.totalCases++;
                client.caseTypes.add(c.type);
                
                if (c.status === 'completed') {
                    client.completedCases++;
                } else {
                    client.activeCases++;
                }
                
                if (c.status === 'urgent') {
                    client.urgentCases++;
                }
                
                // Update last activity date
                if (new Date(c.createdDate) > new Date(client.lastActivity)) {
                    client.lastActivity = c.createdDate;
                }
                
                // Update contact if more recent case has contact info
                if (c.contact && (!client.contact || client.contact === 'Not provided')) {
                    client.contact = c.contact;
                }
            });
            
            // Convert Set to Array and calculate averages
            const clientsArray = Array.from(clientsMap.values()).map(client => ({
                ...client,
                caseTypes: Array.from(client.caseTypes),
                averageProgress: client.cases.length ? Math.round(client.cases.reduce((sum, c) => sum + c.progress, 0) / client.cases.length) : 0
            }));
            
            return clientsArray;
        }

        function renderClients() {
            const container = document.getElementById('clientsContainer');
            const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
            const sortBy = document.getElementById('clientSortBy').value;
            
            let clientsData = getClientsData();
            
            // Filter clients
            if (searchTerm) {
                clientsData = clientsData.filter(client => 
                    client.name.toLowerCase().includes(searchTerm) ||
                    client.contact.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort clients
            clientsData.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'cases':
                        return b.totalCases - a.totalCases;
                    case 'recent':
                        return new Date(b.lastActivity) - new Date(a.lastActivity);
                    default:
                        return 0;
                }
            });
            
            if (clientsData.length === 0) {
                container.innerHTML = `
                    <div class="no-cases">
                        <div class="no-cases-icon">üë•</div>
                        <h3>No clients found</h3>
                        <p>${cases.length === 0 ? 'Add cases to see your clients here' : 'Try adjusting your search'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clientsData.map(client => `
                <div class="client-card">
                    <div class="client-name">${client.name}</div>
                    <div style="color: #6c757d; margin: 10px 0;">
                        üìß ${client.contact}
                    </div>
                    <div style="color: #6c757d; margin-bottom: 15px; font-size: 0.9em;">
                        Last activity: ${new Date(client.lastActivity).toLocaleDateString()}
                    </div>
                    
                    <div class="client-stats">
                        <div class="client-stat">
                            <strong>${client.totalCases}</strong> Total Cases
                        </div>
                        <div class="client-stat">
                            <strong>${client.activeCases}</strong> Active
                        </div>
                        <div class="client-stat">
                            <strong>${client.completedCases}</strong> Completed
                        </div>
                        ${client.urgentCases > 0 ? `
                        <div class="client-stat" style="background: #ffebee; color: #c62828;">
                            <strong>${client.urgentCases}</strong> Urgent
                        </div>
                        ` : ''}
                        <div class="client-stat">
                            <strong>${client.averageProgress}%</strong> Avg Progress
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <strong>Case Types:</strong> ${client.caseTypes.join(', ')}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <strong>Recent Cases:</strong>
                        ${client.cases.slice(0, 3).map(c => `
                            <div class="client-case-item">
                                <div style="font-weight: 500; color: #2c3e50;">${c.title}</div>
                                <div style="font-size: 0.85em; color: #6c757d; margin-top: 4px;">
                                    ${c.type} ‚Ä¢ ${c.status} ‚Ä¢ ${c.progress}% complete
                                    ${c.deadline ? ` ‚Ä¢ Due: ${new Date(c.deadline).toLocaleDateString()}` : ''}
                                </div>
                            </div>
                        `).join('')}
                        ${client.cases.length > 3 ? `
                            <div style="text-align: center; color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                                ... and ${client.cases.length - 3} more case${client.cases.length - 3 > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Stats and UI Functions
        function updateStats() {
            const total = cases.length;
            const active = cases.filter(c => c.status !== 'completed').length;
            const urgent = cases.filter(c => c.status === 'urgent').length;
            const completed = cases.filter(c => c.status === 'completed').length;
            const totalClients = new Set(cases.map(c => c.client)).size;

            document.getElementById('totalCases').textContent = total;
            document.getElementById('activeCases').textContent = active;
            document.getElementById('urgentCases').textContent = urgent;
            document.getElementById('completedCases').textContent = completed;
            document.getElementById('totalClients').textContent = totalClients;
        }

        function switchTab(tabName, element) {
            // Update tab buttons
            document.querySelectorAll('.reminder-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'clients') {
                renderClients();
            }
        }

        // Case Management Functions
        function openAddCaseModal() {
            editingCaseId = null;
            document.getElementById('modalTitle').textContent = 'Add New Case';
            document.getElementById('caseForm').reset();
            document.getElementById('progressDisplay').textContent = '0%';
            document.getElementById('caseModal').style.display = 'block';
        }

        function openEditCaseModal(caseId) {
            editingCaseId = caseId;
            const caseData = cases.find(c => c.id === caseId);
            
            document.getElementById('modalTitle').textContent = 'Edit Case';
            document.getElementById('caseTitle').value = caseData.title;
            document.getElementById('clientName').value = caseData.client;
            document.getElementById('clientContact').value = caseData.contact || '';
            document.getElementById('caseType').value = caseData.type;
            document.getElementById('deadline').value = caseData.deadline || '';
            document.getElementById('priority').value = caseData.priority;
            document.getElementById('progress').value = caseData.progress;
            document.getElementById('workDone').value = caseData.workDone || '';
            document.getElementById('nextSteps').value = caseData.nextSteps || '';
            document.getElementById('notes').value = caseData.notes || '';
            
            updateProgressDisplay();
            document.getElementById('caseModal').style.display = 'block';
        }

        function closeCaseModal() {
            document.getElementById('caseModal').style.display = 'none';
            editingCaseId = null;
        }

        function updateProgressDisplay() {
            const progress = document.getElementById('progress').value;
            document.getElementById('progressDisplay').textContent = progress + '%';
        }

        function deleteCase(caseId) {
            if (confirm('Are you sure you want to delete this case? This action cannot be undone.')) {
                cases = cases.filter(c => c.id !== caseId);
                saveCases();
                renderCases();
                updateStats();
                renderClients();
            }
        }

        function toggleCaseStatus(caseId) {
            const caseIndex = cases.findIndex(c => c.id === caseId);
            if (cases[caseIndex].status === 'completed') {
                cases[caseIndex].status = cases[caseIndex].priority;
                cases[caseIndex].progress = Math.min(cases[caseIndex].progress, 95);
            } else {
                cases[caseIndex].status = 'completed';
                cases[caseIndex].progress = 100;
            }
            
            saveCases();
            renderCases();
            updateStats();
            renderClients();
        }

        function renderCases() {
            const container = document.getElementById('casesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filteredCases = cases.filter(c => {
                const matchesSearch = c.title.toLowerCase().includes(searchTerm) || 
                                    c.client.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || c.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            // Sort cases
            filteredCases.sort((a, b) => {
                switch(sortBy) {
                    case 'deadline':
                        return new Date(a.deadline || '9999-12-31') - new Date(b.deadline || '9999-12-31');
                    case 'client':
                        return a.client.localeCompare(b.client);
                    case 'progress':
                        return b.progress - a.progress;
                    case 'created':
                        return new Date(b.createdDate) - new Date(a.createdDate);
                    default:
                        return 0;
                }
            });

            if (filteredCases.length === 0) {
                container.innerHTML = `
                    <div class="no-cases">
                        <div class="no-cases-icon">üìã</div>
                        <h3>No cases found</h3>
                        <p>${cases.length === 0 ? 'Click "Add New Case" to get started' : 'Try adjusting your search or filter'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredCases.map(c => {
                const daysUntilDeadline = c.deadline ? 
                    Math.ceil((new Date(c.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                const deadlineText = daysUntilDeadline !== null ? 
                    (daysUntilDeadline < 0 ? `${Math.abs(daysUntilDeadline)} days overdue` :
                     daysUntilDeadline === 0 ? 'Due today' :
                     `${daysUntilDeadline} days left`) : 'No deadline';

                return `
                    <div class="case-card ${c.status}">
                        <div class="case-header">
                            <div>
                                <div class="case-title">${c.title}</div>
                                <div class="case-client">üë§ ${c.client}</div>
                            </div>
                            <span class="status-badge status-${c.status}">${c.status}</span>
                        </div>
                        
                        <div class="case-details">
                            <div class="detail-row">
                                <span class="detail-label">üìß Contact:</span>
                                <span class="detail-value">${c.contact || 'Not provided'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">‚öñÔ∏è Type:</span>
                                <span class="detail-value">${c.type}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üìÖ Deadline:</span>
                                <span class="detail-value ${daysUntilDeadline !== null && daysUntilDeadline <= 3 ? 'text-red-600 font-bold' : ''}">${c.deadline || 'Not set'}</span>
                            </div>
                            ${daysUntilDeadline !== null ? `
                            <div class="detail-row">
                                <span class="detail-label">‚è∞ Status:</span>
                                <span class="detail-value ${daysUntilDeadline <= 3 && daysUntilDeadline >= 0 ? 'text-red-600 font-bold' : daysUntilDeadline < 0 ? 'text-red-800 font-bold' : ''}">${deadlineText}</span>
                            </div>
                            ` : ''}
                        </div>

                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${c.progress}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #7f8c8d;">
                            Progress: ${c.progress}%
                        </div>

                        ${c.workDone ? `
                        <div style="margin: 15px 0;">
                            <strong>Work Done:</strong>
                            <p style="color: #7f8c8d; margin-top: 5px; font-size: 0.9em;">${c.workDone}</p>
                        </div>
                        ` : ''}

                        ${c.nextSteps ? `
                        <div style="margin: 15px 0;">
                            <strong>Next Steps:</strong>
                            <p style="color: #7f8c8d; margin-top: 5px; font-size: 0.9em;">${c.nextSteps}</p>
                        </div>
                        ` : ''}

                        <div class="case-actions">
                            <button class="btn btn-primary btn-small" onclick="openEditCaseModal(${c.id})">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="toggleCaseStatus(${c.id})">
                                ${c.status === 'completed' ? 'üîÑ Reopen' : '‚úÖ Complete'}
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="deleteCase(${c.id})" style="background: #e74c3c; color: white;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Form submission
        document.getElementById('caseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('caseTitle').value,
                client: document.getElementById('clientName').value,
                contact: document.getElementById('clientContact').value,
                type: document.getElementById('caseType').value,
                deadline: document.getElementById('deadline').value,
                priority: document.getElementById('priority').value,
                progress: parseInt(document.getElementById('progress').value),
                workDone: document.getElementById('workDone').value,
                nextSteps: document.getElementById('nextSteps').value,
                notes: document.getElementById('notes').value
            };

            if (editingCaseId) {
                // Update existing case
                const caseIndex = cases.findIndex(c => c.id === editingCaseId);
                cases[caseIndex] = { ...cases[caseIndex], ...formData };
                cases[caseIndex].status = formData.progress === 100 ? 'completed' : formData.priority;
            } else {
                // Add new case
                const newCase = {
                    id: Date.now(),
                    ...formData,
                    createdDate: new Date().toISOString().split('T')[0],
                    status: formData.progress === 100 ? 'completed' : formData.priority
                };
                cases.push(newCase);
            }

            if (saveCases()) {
                renderCases();
                updateStats();
                renderClients();
                closeCaseModal();
            }
        });

        // Data export/import functions
        function exportData() {
            try {
                const exportData = {
                    cases: cases,
                    exportDate: new Date().toISOString(),
                    version: "2.0"
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `case-diary-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let importedCases = [];
                        
                        // Handle different import formats
                        if (Array.isArray(importedData)) {
                            importedCases = importedData;
                        } else if (importedData.cases && Array.isArray(importedData.cases)) {
                            importedCases = importedData.cases;
                        } else {
                            throw new Error('Invalid file format');
                        }
                        
                        if (confirm(`This will replace all current cases with ${importedCases.length} imported cases. Continue?`)) {
                            cases = importedCases;
                            if (saveCases()) {
                                renderCases();
                                updateStats();
                                renderClients();
                                alert('Cases imported successfully!');
                            }
                        }
                    } catch (error) {
                        alert('Error reading file. Please check the file format.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL cases? This cannot be undone!')) {
                if (confirm('This will permanently delete all your cases. Are you absolutely sure?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    cases = [];
                    renderCases();
                    updateStats();
                    renderClients();
                    alert('All data cleared successfully!');
                }
            }
        }

        // Event Listeners and Initialization
        window.onload = function() {
            loadCases();
            renderCases();
            updateStats();
            updateStorageStatus();
            
            // Add event listeners for search and filter
            document.getElementById('searchInput').addEventListener('input', renderCases);
            document.getElementById('statusFilter').addEventListener('change', renderCases);
            document.getElementById('sortBy').addEventListener('change', renderCases);

            // Add event listeners for client search and sort
            document.getElementById('clientSearchInput').addEventListener('input', renderClients);
            document.getElementById('clientSortBy').addEventListener('change', renderClients);
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('caseModal');
            if (event.target === modal) {
                closeCaseModal();
            }
        }
    </script>
</body>
</html>